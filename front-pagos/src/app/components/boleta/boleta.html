<div class="min-h-screen p-4 sm:p-6 lg:p-8">
  <!-- Grid principal de 2 columnas en pantallas grandes: formulario a la izquierda, detalles y lista a la derecha -->
  <div class="grid grid-cols-1 xl:grid-cols-5 gap-6 mb-6">
    <!-- Columna izquierda: sección para crear la boleta (ocupa 2/5 del espacio en xl) -->
    <div class="xl:col-span-2 bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-3">
        Crear boleta
      </h2>

      <!-- Mostrar información del encargado si está disponible -->
      <div
        *ngIf="nombreEncargado"
        class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-4">
        <span class="text-sm font-medium text-gray-700">
          Encargado: <span class="font-semibold">{{ nombreEncargado }}</span>
          (DNI: <span class="font-semibold">{{ dniEncargado }}</span>)
        </span>
      </div>

      <!-- Formulario principal para enviar la boleta -->
      <form (ngSubmit)="submit()" class="space-y-4">
        <!-- Sección de información del cliente -->
        <div class="space-y-4">
          <!-- Campo para nombre del cliente (requerido) -->
          <div>
            <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">
              Nombre cliente <span class="text-red-500">*</span>
            </label>
            <input
              id="nombre"
              name="nombre"
              required
              [(ngModel)]="nombre"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="Nombre completo del cliente" />
          </div>

          <!-- Campo para documento de identidad (requerido) -->
          <div>
            <label for="documento" class="block text-sm font-medium text-gray-700 mb-1">
              Documento identidad <span class="text-red-500">*</span>
            </label>
            <input
              id="documento"
              name="documento"
              required
              [(ngModel)]="documentoIdentidad"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="DNI del cliente" />
          </div>

          <!-- Campo para dirección (opcional) -->
          <div>
            <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">
              Direccion
            </label>
            <input
              id="direccion"
              name="direccion"
              [(ngModel)]="direccion"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="Direccion del cliente" />
          </div>

          <!-- Campo para fecha de emisión (requerido) -->
          <div>
            <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">
              Fecha de emision <span class="text-red-500">*</span>
            </label>
            <input
              id="fecha"
              name="fecha"
              type="date"
              required
              [(ngModel)]="fechaEmision"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors" />
          </div>
        </div>

        <!-- Separador visual -->
        <hr class="my-6 border-gray-200" />

        <!-- Sección para agregar detalles, con toggle entre buscar y seleccionar -->
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold text-gray-800">
              Agregar detalle
            </h3>
            
            <!-- Botones para alternar entre modo de búsqueda y selección -->
            <div class="flex gap-2 text-xs">
              <button
                type="button"
                (click)="cambiarModoSeleccion('buscar')"
                [class.bg-blue-500]="modoSeleccion === 'buscar'"
                [class.text-white]="modoSeleccion === 'buscar'"
                [class.bg-gray-200]="modoSeleccion !== 'buscar'"
                [class.text-gray-700]="modoSeleccion !== 'buscar'"
                class="px-3 py-1 rounded-md transition-colors">
                Buscar
              </button>
              <button
                type="button"
                (click)="cambiarModoSeleccion('seleccionar')"
                [class.bg-blue-500]="modoSeleccion === 'seleccionar'"
                [class.text-white]="modoSeleccion === 'seleccionar'"
                [class.bg-gray-200]="modoSeleccion !== 'seleccionar'"
                [class.text-gray-700]="modoSeleccion !== 'seleccionar'"
                class="px-3 py-1 rounded-md transition-colors">
                Seleccionar
              </button>
            </div>
          </div>

          <div class="space-y-3">
            <!-- Modo búsqueda: autocompletado para conceptos -->
            <div *ngIf="modoSeleccion === 'buscar'" class="relative autocomplete-container">
              <label for="busqueda-concepto" class="block text-sm font-medium text-gray-700 mb-1">
                Buscar concepto
              </label>
              <input
                id="busqueda-concepto"
                name="busqueda-concepto"
                type="text"
                [(ngModel)]="busquedaConcepto"
                (input)="filtrarConceptos()"
                (focus)="filtrarConceptos()"
                placeholder="Escribe para buscar o haz click para ver opciones..."
                autocomplete="off"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors" />
              
              <!-- Dropdown de opciones filtradas -->
              <div
                *ngIf="mostrarAutocompletado"
                class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                <div
                  *ngFor="let concepto of conceptosFiltrados"
                  (click)="seleccionarConcepto(concepto)"
                  class="px-4 py-3 hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-100 last:border-b-0">
                  <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-medium text-gray-900 truncate">{{ concepto.nombre }}</p>
                      <p class="text-xs text-gray-500 mt-0.5">{{ concepto.unidadCompetente }}</p>
                    </div>
                    <span class="ml-3 text-sm text-blue-600 font-semibold whitespace-nowrap">S/. {{ concepto.precio | number:'1.2-2' }}</span>
                  </div>
                </div>
                
                <!-- Mensaje cuando no hay resultados -->
                <div
                  *ngIf="conceptosFiltrados.length === 0"
                  class="px-4 py-6 text-sm text-gray-500 text-center">
                  <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                  No se encontraron conceptos
                </div>
              </div>
            </div>

            <!-- Modo selección: dropdown tradicional -->
            <div *ngIf="modoSeleccion === 'seleccionar'">
              <label for="concepto-select" class="block text-sm font-medium text-gray-700 mb-1">
                Seleccionar concepto
              </label>
              <select
                id="concepto-select"
                name="concepto-select"
                [(ngModel)]="detalleModel.conceptoId"
                (change)="onSelectChange()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors">
                <option [ngValue]="null">-- seleccionar --</option>
                <option *ngFor="let c of conceptos" [ngValue]="c.id">
                  {{ c.nombre }} - S/. {{ c.precio | number:'1.2-2' }}
                </option>
              </select>
            </div>

            <!-- Campo para cantidad -->
            <div>
              <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1">
                Cantidad
              </label>
              <input
                id="cantidad"
                name="cantidad"
                type="number"
                min="1"
                [(ngModel)]="detalleModel.cantidad"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors"
                placeholder="1" />
            </div>
          </div>

          <!-- Botón para agregar detalle -->
          <button
            type="button"
            (click)="agregarDetalle()"
            class="mt-3 w-full px-4 py-2 btn-primary rounded-md hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            + Agregar detalle
          </button>
        </div>

        <!-- Mensajes de éxito o error -->
        <div *ngIf="message" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-md text-success">
          {{ message }}
        </div>
        <div *ngIf="error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-danger">
          {{ error }}
        </div>
      </form>
    </div>

    <!-- Columna derecha: detalles, total y listas (ocupa 3/5 del espacio en xl) -->
    <div class="xl:col-span-3 space-y-5">
      <!-- Tabla de detalles agregados (siempre visible) -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h4 class="text-lg font-semibold text-gray-800 mb-3">
          Detalles ({{ detallesForm.length }})
        </h4>

        <!-- Tabla con scroll horizontal si es necesario -->
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Concepto
                </th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Cantidad
                </th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Precio
                </th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Subtotal
                </th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Accion
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <!-- Fila cuando no hay detalles -->
              <tr *ngIf="detallesForm.length === 0">
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                  No hay detalles agregados aun
                  <br>
                  <span class="text-sm">Busca y agrega conceptos desde el panel izquierdo</span>
                </td>
              </tr>
              <!-- Filas de detalles -->
              <tr *ngFor="let d of detallesForm" class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 text-sm text-gray-900">{{ d.nombre }}</td>
                <td class="px-4 py-3 text-sm text-center text-gray-700">{{ d.cantidad }}</td>
                <td class="px-4 py-3 text-sm text-right text-gray-700">S/. {{ d.precioUnitario | number:'1.2-2' }}</td>
                <td class="px-4 py-3 text-sm text-right font-semibold text-gray-900">S/. {{ d.subtotal | number:'1.2-2' }}</td>
                <td class="px-4 py-3 text-center">
                  <button
                    type="button"
                    (click)="quitarDetalle(d.conceptoId)"
                    class="px-3 py-1 btn-danger rounded-md text-sm hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Quitar
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Total calculado -->
        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-md p-4 flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-800">Total:</span>
          <span class="text-2xl font-bold text-blue-600">S/. {{ total.toFixed(2) }}</span>
        </div>

        <!-- Botón para enviar el formulario -->
        <div class="mt-4">
          <button
            type="submit"
            (click)="submit()"
            [disabled]="loading || detallesForm.length === 0"
            class="w-full px-6 py-3 btn-success rounded-md font-medium hover:shadow-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <span *ngIf="!loading">Crear boleta</span>
            <span *ngIf="loading">Creando...</span>
          </button>
        </div>
      </div>

      <!-- Componente para lista de boletas pendientes -->
      <app-lista-boletas></app-lista-boletas>
    </div>
  </div>

  <!-- Componente para historial completo del usuario (ancho completo abajo) -->
  <app-historial-usuario></app-historial-usuario>
</div>